<!--
    wl-11-04-2018, wed: commence
    wl-12-04-2018, Thu: first working draft
-->

<tool id="isolab" name="IsotopicLabelling" version="0.1.0">
  <description>
    Mass Spectrometric Isotopic Labelling
  </description>
  
  <!-- =============================================================== -->
  <command>
    <![CDATA[
      Rscript ${__tool_directory__}/isolab.R
        ## input files
        --peak_file $peak_file 
        --targ_file $targ_file 
        
        ## Average estimate for groups
        --grp $grp.grp_selector
        #if $grp:
          --groups $grp.groups
        #end if

        ## Plot results
        --pattern_plot $pattern_plot
        --residual_plot $residual_plot
        --result_plot $result_plot 

        ## output pdf files
        #if $pattern_plot:
          --pattern_file $pattern_file
        #end if
        #if $residual_plot:
          --residual_file $residual_file
        #end if
        #if $result_plot:
          --result_file $result_file
        #end if

        ## Output Excel files
        --summary_file $summary_file 
        #if $grp:
           --summary_grp_file $summary_grp_file
        #end if

    ]]>
  </command>

  <!-- =============================================================== -->
  <inputs>
    <param name="peak_file" type="data"  format="tabular" label="Data matrix" 
           help="Data matrix containing the integrated signals for the
                 samples. The first two columns represent the mass and the
                 retention time of the peaks; the other columns represent
                 peak intensities for each sample." />

    <param name="targ_file" type="data"  format="tabular" 
           label="Targets matrix" 
           help="A data matrix containing information on the target analytes.
                 Columns 1 to 8 are: 'name_compound' (the name of the target
                 analytes), 'compound', 'charge', 'labelling', 'RT',
                 'RT_shift', 'chrom_width', 'mass_shift'.  Columns from 9
                 onwards contain the initial estimates for the label
                 abundances (one estimate for each sample). If not known,
                 a single column of NA values can be entered" />

    <!-- =============================================================== -->
    <conditional name="grp">
      <param name="grp_selector"
             type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true"
             label="Average estimate within groups" 
             help="Calculate summary statistics for the samples belonging to 
                   the same group."/>

      <when value="TRUE">
        <param name="groups" type="text" value=""
               label="Specify group information"
               help="A vector containing the name of the group of each sample
                     analysed." />
      </when>

      <when value="FALSE">
      </when>

    </conditional>

    <!-- =============================================================== -->
    <param name="pattern_plot" type="boolean" truevalue="True" 
           falsevalue="False" checked="true" label="Plot patterns" 
           help="Plot the normalized experimental pattern superimposed to 
                 its fitted theoretical pattern." />
    <param name="residual_plot" type="boolean" truevalue="True" 
           falsevalue="False" checked="true" label="Plot residuals" 
           help="Plot the residuals (the differences between 
                 experimental and best fitted theoretical patterns)" />
    <param name="result_plot" type="boolean" truevalue="True" 
           falsevalue="False" checked="true" label="Plot results" 
           help="Plot summary showing the estimated percentage abundances
                 with related standard errors." />

  </inputs>


  <!-- =============================================================== -->
  <outputs>
    <data format="pdf" name="pattern_file"
          label="Pattern plot on ${on_string}">
      <filter> pattern_plot == True </filter>
    </data>
    <data format="pdf" name="residual_file"
          label="Residual plot on ${on_string}">
      <filter> residual_plot == True </filter>
    </data>
    <data format="pdf" name="result_file"
          label="Result summary plot on ${on_string}">
      <filter> result_plot == True </filter>
    </data>
    <data format="xlsx" name="summary_file" 
          label="Result summary on ${on_string}"/>
    <data format="xlsx" name="summary_grp_file" 
          label="Group result summary on ${on_string}" >
      <filter> grp['grp_selector'] == True </filter>
    </data>
    
  </outputs>

  <!-- =============================================================== -->
  <tests>
    <test>
      <param name="peak_file" value="xcms_obj.tsv" />
      <param name="targ_file" value="targets.tsv" />
      <param name="grp_selector" value="TURE" /> 
      <param name="groups" value="C12,C12,C12,C12,C13,C13,C13,C13" /> 
      <param name="pattern_plot" value="TRUE" /> 
      <param name="residual_plot" value="TRUE" /> 
      <param name="result_plot" value="TRUE" /> 
      <output name="pattern_file" file="pattern.pdf" />
      <output name="residual_file" file="residual.pdf" />
      <output name="result_file" file="result.pdf" />
      <output name="summary_file" file="summary.xlsx" />
      <output name="summary_grp_file" file="summary_grp.xlsx" />
    </test>
  </tests>


  <!-- =============================================================== -->
  <help>
    This is a basic Galaxy wrapper for pre-processing. 
  </help>

</tool>
